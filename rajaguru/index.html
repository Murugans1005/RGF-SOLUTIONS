<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAJAGURU CMS v15 - Tally Logic</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: auto; display: none; }
        #loginPage { max-width: 400px; margin: 80px auto; background: white; padding: 40px; border-radius: 25px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-top: 10px solid #d32f2f; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; }
        .header { background: #d32f2f; color: white; padding: 15px; text-align: center; border-radius: 12px; margin-bottom: 10px; position: relative; }
        .logout-btn { position: absolute; right: 10px; top: 15px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .s-card { background: white; padding: 12px; border-radius: 10px; text-align: center; border-top: 4px solid #d32f2f; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .s-card p { margin: 5px 0 0; font-weight: bold; font-size: 16px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border-left: 6px solid #d32f2f; }
        label { display: block; font-weight: bold; margin-top: 10px; font-size: 13px; color: #555; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        .denom-box { background: #fff8f8; padding: 15px; border-radius: 12px; border: 1px dashed #d32f2f; margin-top: 15px; display: none; }
        .denom-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .denom-row span { width: 45px; font-weight: bold; }
        .denom-row input { width: 75px; text-align: center; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 17px; font-weight: bold; cursor: pointer; color: white; margin-top: 12px; }
        .btn-save { background: #2e7d32; }
        .btn-wa { background: #25D366; }
        .btn-admin { background: #1a237e; }
        #adminView { display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; }
        th { background: #1a237e; color: white; }
        .act-btn { cursor: pointer; font-size: 18px; margin: 0 8px; }
        .back-btn { background: #f39c12; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 15px; }
        .tally-msg { margin-top: 10px; font-size: 12px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div id="loginPage">
    <h2 style="color:#d32f2f;">RGF SOLUTIONS</h2>
    <input type="text" id="username" class="login-input" placeholder="User ID">
    <input type="password" id="password" class="login-input" placeholder="Password">
    <button class="btn btn-save" onclick="handleLogin()">LOGIN</button>
</div>

<div class="container" id="mainApp">
    <div class="header">
        <button class="logout-btn" onclick="location.reload()">Logout</button>
        <h2 style="margin:0;">RAJAGURU TRACKER</h2>
    </div>
    
    <div class="summary-grid">
        <div class="s-card"><h4>BOM RHA</h4><p id="sumB1">‚Çπ0</p></div>
        <div class="s-card"><h4>Airtel A/C</h4><p id="sumB2">‚Çπ0</p></div>
        <div class="s-card"><h4>Pandi ID</h4><p id="sumB3">‚Çπ0</p></div>
    </div>

    <div id="entrySection">
        <div class="card">
            <h3 id="formTitle" style="margin:0; color:#d32f2f;">New Entry (Tally Mode)</h3>
            <input type="hidden" id="editId">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Date</label><input type="date" id="date" value="2026-01-11"></div>
                <div style="flex:1;"><label>Time</label><input type="time" id="time"></div>
            </div>
            
            <label style="color:#2980b9;">1. Airtel ‚ûî Rajapandi (Load Amount)</label>
            <input type="number" id="a2p" placeholder="‚Çπ Enter Load Amount" oninput="calculateTally()">

            <label style="color:#27ae60;">2. Rajapandi Return Amount</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="p2h" placeholder="‚Çπ Return" oninput="calculateTally()">
                <select id="mode" onchange="toggleDenom()"><option value="Cash">Cash</option><option value="Gpay">Gpay</option><option value="Account">Account</option></select>
            </div>

            <label style="color:#e67e22;">3. Rajapandi ID Balance (Remaining)</label>
            <input type="number" id="pandiIdBal" placeholder="‚Çπ Balance in ID" oninput="calculateTally()">

            <div id="tallyResult" class="tally-msg"></div>

            <div id="denomBox" class="denom-box"><div id="denomInputs"></div><div style="text-align:right; font-weight:bold;">Cash Total: ‚Çπ<span id="grandT">0</span></div></div>
            
            <label>4. BOM RHA ‚ûî Airtel (Transfer Ref)</label>
            <input type="number" id="h2a" placeholder="‚Çπ BOM Transfer">

            <button id="mainSaveBtn" class="btn btn-save" onclick="save()">üíæ SAVE TRANSACTION</button>
            <button class="btn btn-wa" onclick="shareToGroup()">üü¢ SHARE TO WHATSAPP</button>
            <button class="btn btn-admin" onclick="goToAdmin()">üìä VIEW ADMIN REPORT ‚ûî</button>
        </div>
    </div>

    <div id="adminView">
        <button class="back-btn" onclick="goToEntry()">‚¨Ö BACK TO ENTRY FORM</button>
        <div class="card">
            <h3 style="margin-top:0; color:#1a237e;">Transaction History</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Date</th><th>Load</th><th>Return</th><th>ID Bal</th><th>Tally</th><th>Action</th></tr></thead>
                    <tbody id="reportTbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCTfzmnIMbryZuGCm4iq_3C1vrjQk4BWF4",
        authDomain: "rgf-solutions.firebaseapp.com",
        databaseURL: "https://rgf-solutions-default-rtdb.firebaseio.com",
        projectId: "rgf-solutions",
        storageBucket: "rgf-solutions.firebasestorage.app",
        messagingSenderId: "324475817892",
        appId: "1:324475817892:web:103ecc2311e6b459f4fb31"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function handleLogin() {
        if(document.getElementById('username').value === "SMurugan" && document.getElementById('password').value === "Manager") {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadReport();
        } else { alert("Login Thappu!"); }
    }

    const notes = [500, 200, 100, 50, 20, 10, 5, 2, 1];
    const dDiv = document.getElementById('denomInputs');
    notes.forEach(n => { dDiv.innerHTML += `<div class="denom-row"><span>${n} x</span><input type="number" class="ni" id="n_${n}" oninput="calcCash()"></div>`; });
    
    function toggleDenom() { document.getElementById('denomBox').style.display = (document.getElementById('mode').value === 'Cash' ? 'block' : 'none'); }
    
    function calcCash() {
        let t = 0; notes.forEach(n => { t += (n * (parseInt(document.getElementById('n_'+n).value) || 0)); });
        document.getElementById('grandT').innerText = t; 
        document.getElementById('p2h').value = t;
        calculateTally();
    }

    function calculateTally() {
        const load = parseFloat(document.getElementById('a2p').value) || 0;
        const ret = parseFloat(document.getElementById('p2h').value) || 0;
        const idBal = parseFloat(document.getElementById('pandiIdBal').value) || 0;
        const diff = load - (ret + idBal);
        const resDiv = document.getElementById('tallyResult');
        
        if (load === 0) { resDiv.innerHTML = ""; return; }
        
        if (diff === 0) {
            resDiv.style.color = "green";
            resDiv.innerText = "‚úÖ Tally Matched! (Equal)";
        } else {
            resDiv.style.color = "red";
            resDiv.innerText = `‚ùå Not Equal! Diff: ‚Çπ${diff.toFixed(2)}`;
        }
    }

    function save() {
        const id = document.getElementById('editId').value || Date.now();
        const data = {
            date: document.getElementById('date').value, 
            time: document.getElementById('time').value,
            a2p: parseFloat(document.getElementById('a2p').value) || 0,
            p2h: parseFloat(document.getElementById('p2h').value) || 0,
            idBal: parseFloat(document.getElementById('pandiIdBal').value) || 0,
            h2a: parseFloat(document.getElementById('h2a').value) || 0,
            mode: document.getElementById('mode').value,
            tallyStatus: (parseFloat(document.getElementById('a2p').value) === (parseFloat(document.getElementById('p2h').value) + parseFloat(document.getElementById('pandiIdBal').value))) ? "Matched" : "Mismatch"
        };
        db.ref('rajaguru_tracker/' + id).set(data).then(() => { 
            alert("Saved Mapla!"); 
            resetForm();
        });
    }

    function resetForm() {
        ["a2p","p2h","pandiIdBal","h2a","editId"].forEach(i => document.getElementById(i).value = "");
        document.getElementById('formTitle').innerText = "New Entry (Tally Mode)";
        document.getElementById('tallyResult').innerText = "";
        notes.forEach(n => document.getElementById('n_'+n).value = "");
    }

    let allData = {};
    function loadReport() {
        db.ref('rajaguru_tracker').on('value', snap => {
            const tbody = document.getElementById('reportTbody'); tbody.innerHTML = "";
            let b1=0, b2=0, b3=0; allData = snap.val() || {};
            Object.keys(allData).reverse().forEach(key => {
                const v = allData[key];
                b2 += (v.h2a - v.a2p); b3 += (v.a2p - v.p2h); b1 += (v.p2h - v.h2a);
                tbody.innerHTML += `<tr><td>${v.date}</td><td>${v.a2p}</td><td>${v.p2h}</td><td>${v.idBal}</td><td style="color:${v.tallyStatus==='Matched'?'green':'red'}">${v.tallyStatus}</td><td>
                    <span class="act-btn" onclick="editEntry('${key}')">‚úèÔ∏è</span>
                    <span class="act-btn" onclick="deleteEntry('${key}')">‚ùå</span>
                </td></tr>`;
            });
            document.getElementById('sumB1').innerText = "‚Çπ"+b1.toLocaleString();
            document.getElementById('sumB2').innerText = "‚Çπ"+b2.toLocaleString();
            document.getElementById('sumB3').innerText = "‚Çπ"+b3.toLocaleString();
        });
    }

    function editEntry(key) {
        const v = allData[key];
        document.getElementById('editId').value = key;
        document.getElementById('date').value = v.date;
        document.getElementById('a2p').value = v.a2p;
        document.getElementById('p2h').value = v.p2h;
        document.getElementById('pandiIdBal').value = v.idBal;
        document.getElementById('h2a').value = v.h2a;
        document.getElementById('mode').value = v.mode;
        calculateTally();
        goToEntry();
    }

    function deleteEntry(key) { if(confirm("Delete?")) db.ref('rajaguru_tracker/' + key).remove(); }
    function goToAdmin() { document.getElementById('entrySection').style.display = 'none'; document.getElementById('adminView').style.display = 'block'; }
    function goToEntry() { document.getElementById('entrySection').style.display = 'block'; document.getElementById('adminView').style.display = 'none'; }
    
    function shareToGroup() {
        const msg = `*üìä RAJAGURU TALLY REPORT*\nüìÖ *Date:* ${document.getElementById('date').value}\nüì± *Airtel ‚ûî Pandi:* ‚Çπ${document.getElementById('a2p').value}\nüíµ *Return:* ‚Çπ${document.getElementById('p2h').value}\nüö© *ID Bal:* ‚Çπ${document.getElementById('pandiIdBal').value}\n----------------------------------\n‚úÖ *Status:* ${document.getElementById('tallyResult').innerText}`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
    }
</script>
</body>
</html>
