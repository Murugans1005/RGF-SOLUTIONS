<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAJAGURU CMS v38 - Opening Balance</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: auto; display: none; }
        #loginPage { max-width: 400px; margin: 80px auto; background: white; padding: 40px; border-radius: 25px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-top: 10px solid #d32f2f; }
        .header { background: #d32f2f; color: white; padding: 15px; text-align: center; border-radius: 12px; margin-bottom: 10px; position: relative; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .s-card { background: white; padding: 8px; border-radius: 10px; text-align: center; border-top: 3px solid #d32f2f; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .s-card h4 { margin: 0; font-size: 10px; color: #555; text-transform: uppercase; }
        .s-card p { margin: 4px 0 0; font-weight: bold; font-size: 13px; color: #1a237e; }
        .special-card { background: #fff9c4; border-top-color: #fbc02d; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border-left: 6px solid #d32f2f; }
        .tab-btn-group { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 8px; background: #ddd; font-weight: bold; cursor: pointer; font-size: 11px; }
        .tab-active { background: #d32f2f; color: white; }
        label { display: block; font-weight: bold; margin-top: 10px; font-size: 13px; color: #555; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; margin-top: 12px; }
        .btn-save { background: #2e7d32; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; background: white; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; }
        th { background: #1a237e; color: white; }
        .action-btns { display: flex; gap: 10px; justify-content: center; font-size: 14px; }
        .edit-btn { color: blue; cursor: pointer; }
        .del-btn { color: red; cursor: pointer; }
    </style>
</head>
<body>

<div id="loginPage">
    <h2 style="color:#d32f2f;">RGF SOLUTIONS</h2>
    <input type="text" id="username" placeholder="User ID">
    <input type="password" id="password" placeholder="Password">
    <button class="btn btn-save" onclick="handleLogin()">LOGIN</button>
</div>

<div class="container" id="mainApp">
    <div class="header">
        <h2 style="margin:0;">RAJAGURU TRACKER v38</h2>
        <button style="position:absolute; right:10px; top:15px; color:white; background:none; border:1px solid white; border-radius:5px;" onclick="location.reload()">Logout</button>
    </div>
    
    <div class="summary-grid">
        <div class="s-card"><h4>BOM Bank</h4><p id="sumB1">‚Çπ0</p></div>
        <div class="s-card"><h4>Airtel Bal</h4><p id="sumB2">‚Çπ0</p></div>
        <div class="s-card"><h4>Pandi ID</h4><p id="sumB3">‚Çπ0</p></div>
        <div class="s-card special-card"><h4>WU Bal</h4><p id="sumWU">‚Çπ0</p></div>
        <div class="s-card special-card"><h4>Nelson Bal</h4><p id="sumNelson">‚Çπ0</p></div>
        <div class="s-card special-card"><h4>Cash In Hand</h4><p id="sumCIH">‚Çπ0</p></div>
    </div>

    <div class="tab-btn-group">
        <button class="tab-btn tab-active" onclick="showTab('entryTab', this)">MAIN</button>
        <button class="tab-btn" onclick="showTab('othersTab', this)">WU/NELSON</button>
        <button class="tab-btn" onclick="showTab('expenseTab', this)">EXPENSE</button>
        <button class="tab-btn" onclick="showTab('openingTab', this)">OPENING</button>
        <button class="tab-btn" onclick="showTab('viewTab', this)">REPORTS</button>
    </div>

    <input type="hidden" id="editId">

    <div id="entryTab" class="tab-content"><div class="card">
        <label>Date</label><input type="date" id="date">
        <label>BOM ‚ûî Airtel Load</label><input type="number" id="h2a">
        <label>Airtel ‚ûî Pandi Load</label><input type="number" id="a2p">
        <label>Pandi Return Amount</label>
        <div style="display:flex; gap:10px;"><input type="number" id="p2h"><select id="mode"><option value="Cash">Cash</option><option value="Gpay">Gpay</option><option value="Account">Bank</option></select></div>
        <label>Bank Deposit (CIH ‚ûî Bank)</label><input type="number" id="bomDeposit">
        <button id="mainBtn" class="btn btn-save" onclick="saveData('main')">üíæ SAVE ENTRY</button>
    </div></div>

    <div id="openingTab" class="tab-content" style="display:none;"><div class="card" style="border-left-color: #ff9800;">
        <h3 style="margin:0; color:#e65100;">Set Opening Balance</h3>
        <label>Select Account</label>
        <select id="openCat">
            <option value="Cash">Cash in Hand</option>
            <option value="Bank">BOM Bank</option>
            <option value="WesternUnion">Western Union</option>
            <option value="Nelson">Mr. Nelson</option>
            <option value="Airtel">Airtel Balance</option>
            <option value="PandiID">Pandi ID Balance</option>
        </select>
        <label>Opening Amount</label><input type="number" id="openAmount">
        <button id="openBtn" class="btn" style="background:#ff9800;" onclick="saveData('opening')">üîë SET OPENING</button>
    </div></div>

    <div id="othersTab" class="tab-content" style="display:none;"><div class="card">
        <label>Service</label><select id="otherCat"><option value="WesternUnion">Western Union</option><option value="Nelson">Mr. Nelson</option></select>
        <label>Type</label><select id="otherType"><option value="IN">IN (+)</option><option value="OUT">OUT (-)</option></select>
        <label>Method</label><select id="otherMode"><option value="Cash">Cash</option><option value="Gpay">Gpay</option></select>
        <label>Amount</label><input type="number" id="otherAmount">
        <label>Detail</label><input type="text" id="otherDetail">
        <button id="otherBtn" class="btn" style="background:#1a237e;" onclick="saveData('others')">üíæ SAVE LOG</button>
    </div></div>

    <div id="expenseTab" class="tab-content" style="display:none;"><div class="card">
        <label>Expense Detail</label><input type="text" id="expDetail">
        <label>Amount</label><input type="number" id="expAmount">
        <label>From</label><select id="expMode"><option value="Cash">Cash</option><option value="Gpay">Bank</option></select>
        <button id="expBtn" class="btn" style="background:#f44336;" onclick="saveData('expense')">üí∏ SAVE EXPENSE</button>
    </div></div>

    <div id="viewTab" class="tab-content" style="display:none;"><div class="card">
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <select id="filter" onchange="loadReport()" style="flex:1;"><option value="All">All</option><option value="Entry">Pandi</option><option value="WesternUnion">WU</option><option value="Nelson">Nelson</option><option value="Expense">Expense</option><option value="Opening">Opening</option></select>
            <button onclick="downloadExcel()" style="background:#00703c; color:white; padding:10px; border:none; border-radius:8px;">Excel</button>
        </div>
        <div style="overflow-x:auto;">
            <table id="reportTable"><thead><tr><th>Date</th><th>Category</th><th>Details</th><th>IN</th><th>OUT</th><th>Act</th></tr></thead><tbody id="reportBody"></tbody></table>
        </div>
    </div></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCTfzmnIMbryZuGCm4iq_3C1vrjQk4BWF4",
        authDomain: "rgf-solutions.firebaseapp.com",
        databaseURL: "https://rgf-solutions-default-rtdb.firebaseio.com",
        projectId: "rgf-solutions",
        storageBucket: "rgf-solutions.firebasestorage.app",
        messagingSenderId: "324475817892",
        appId: "1:324475817892:web:103ecc2311e6b459f4fb31"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function handleLogin() {
        if(document.getElementById('username').value.trim()==="Manager" && document.getElementById('password').value.trim()==="Murugan") {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadReport();
        } else { alert("Login Failed!"); }
    }

    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        document.getElementById(id).style.display = 'block';
        btn.classList.add('tab-active');
    }

    function saveData(type) {
        // Edit panrom-ah illa puthu entry-ah check panrom
        const editId = document.getElementById('editId').value;
        const id = editId ? editId : Date.now().toString();
        
        let data = { date: document.getElementById('date').value, id: id };
        
        if(type === 'main') {
            data.category = "Entry";
            data.h2a = Number(document.getElementById('h2a').value); data.a2p = Number(document.getElementById('a2p').value);
            data.p2h = Number(document.getElementById('p2h').value); data.dep = Number(document.getElementById('bomDeposit').value);
            data.mode = document.getElementById('mode').value;
        } else if(type === 'others') {
            data.category = document.getElementById('otherCat').value;
            data.type = document.getElementById('otherType').value; data.mode = document.getElementById('otherMode').value;
            data.amount = Number(document.getElementById('otherAmount').value); data.detail = document.getElementById('otherDetail').value;
        } else if(type === 'expense') {
            data.category = "Expense"; data.detail = document.getElementById('expDetail').value;
            data.amount = Number(document.getElementById('expAmount').value); data.mode = document.getElementById('expMode').value;
        } else if(type === 'opening') {
            data.category = "Opening"; data.detail = document.getElementById('openCat').value;
            data.amount = Number(document.getElementById('openAmount').value);
        }

        db.ref('rgf_v38/' + id).set(data).then(() => { 
            alert(editId ? "Updated Mapla!" : "Saved Mapla!");
            resetForm();
        });
    }

    function resetForm() {
        document.getElementById('editId').value = "";
        const inputs = document.querySelectorAll('input[type="number"], input[type="text"]');
        inputs.forEach(i => i.value = "");
        document.querySelectorAll('.btn').forEach(b => { if(b.innerText.includes("UPDATE")) b.innerText = b.innerText.replace("UPDATE", "SAVE"); });
    }

    function editEntry(id) {
        db.ref('rgf_v38/' + id).once('value', snap => {
            const v = snap.val();
            document.getElementById('editId').value = id;
            document.getElementById('date').value = v.date;
            
            if(v.category === "Entry") {
                showTab('entryTab', document.querySelector('.tab-btn:nth-child(1)'));
                document.getElementById('h2a').value = v.h2a; document.getElementById('a2p').value = v.a2p;
                document.getElementById('p2h').value = v.p2h; document.getElementById('bomDeposit').value = v.dep;
                document.getElementById('mode').value = v.mode;
                document.getElementById('mainBtn').innerText = "üîÑ UPDATE ENTRY";
            } else if(v.category === "Opening") {
                showTab('openingTab', document.querySelector('.tab-btn:nth-child(4)'));
                document.getElementById('openCat').value = v.detail; document.getElementById('openAmount').value = v.amount;
                document.getElementById('openBtn').innerText = "üîÑ UPDATE OPENING";
            } else if(v.category === "Expense") {
                showTab('expenseTab', document.querySelector('.tab-btn:nth-child(3)'));
                document.getElementById('expDetail').value = v.detail; document.getElementById('expAmount').value = v.amount;
                document.getElementById('expMode').value = v.mode;
                document.getElementById('expBtn').innerText = "üîÑ UPDATE EXPENSE";
            } else {
                showTab('othersTab', document.querySelector('.tab-btn:nth-child(2)'));
                document.getElementById('otherCat').value = v.category; document.getElementById('otherType').value = v.type;
                document.getElementById('otherMode').value = v.mode; document.getElementById('otherAmount').value = v.amount;
                document.getElementById('otherDetail').value = v.detail;
                document.getElementById('otherBtn').innerText = "üîÑ UPDATE LOG";
            }
        });
    }

    function deleteEntry(id) {
        if(confirm("Delete pannava Mapla?")) {
            db.ref('rgf_v38/' + id).remove().then(() => alert("Deleted!"));
        }
    }

    function loadReport() {
        const filter = document.getElementById('filter').value;
        db.ref('rgf_v38').on('value', snap => {
            const tbody = document.getElementById('reportBody'); tbody.innerHTML = "";
            let bom=0, airtel=0, pandi=0, cih=0, wu=0, nelson=0;
            const all = snap.val() || {};
            
            // Sort keys to process older entries first for correct running balance
            Object.keys(all).sort().forEach(k => {
                const v = all[k];
                if(v.category === "Opening") {
                    if(v.detail === "Cash") cih += v.amount;
                    if(v.detail === "Bank") bom += v.amount;
                    if(v.detail === "WesternUnion") wu += v.amount;
                    if(v.detail === "Nelson") nelson += v.amount;
                    if(v.detail === "Airtel") airtel += v.amount;
                    if(v.detail === "PandiID") pandi += v.amount;
                }
                else if(v.category === "Entry") {
                    bom += (v.dep - v.h2a); airtel += (v.h2a - v.a2p); pandi += (v.a2p - v.p2h);
                    if(v.mode === "Cash") cih += v.p2h; else if(v.mode === "Gpay" || v.mode === "Account") bom += v.p2h;
                    cih -= v.dep;
                } else if(v.category === "Expense") {
                    if(v.mode === "Cash") cih -= v.amount; else bom -= v.amount;
                } else if(v.category === "WesternUnion" || v.category === "Nelson") {
                    let amt = v.amount;
                    if(v.category === "WesternUnion") {
                        if(v.type === "IN") { wu += amt; if(v.mode==="Cash") cih += amt; else bom += amt; } 
                        else { wu -= amt; if(v.mode==="Cash") cih -= amt; else bom -= amt; }
                    } else {
                        if(v.type === "IN") { nelson += amt; if(v.mode==="Cash") cih += amt; else bom += amt; } 
                        else { nelson -= amt; if(v.mode==="Cash") cih -= amt; else bom -= amt; }
                    }
                }

                if(filter === "All" || v.category === filter) {
                    let inVal = v.amount || v.a2p || v.dep || '-';
                    let outVal = v.p2h || v.h2a || v.type || '-';
                    tbody.innerHTML = `<tr>
                        <td>${v.date}</td>
                        <td>${v.category}</td>
                        <td>${v.detail || v.mode}</td>
                        <td>${inVal}</td>
                        <td>${outVal}</td>
                        <td class="action-btns">
                            <span class="edit-btn" onclick="editEntry('${k}')">‚úèÔ∏è</span>
                            <span class="del-btn" onclick="deleteEntry('${k}')">‚ùå</span>
                        </td>
                    </tr>` + tbody.innerHTML;
                }
            });
            document.getElementById('sumB1').innerText = "‚Çπ"+bom; document.getElementById('sumB2').innerText = "‚Çπ"+airtel;
            document.getElementById('sumB3').innerText = "‚Çπ"+pandi; document.getElementById('sumCIH').innerText = "‚Çπ"+cih;
            document.getElementById('sumWU').innerText = "‚Çπ"+wu; document.getElementById('sumNelson').innerText = "‚Çπ"+nelson;
        });
    }

    function downloadExcel() { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById("reportTable")), "Rajaguru_v38.xlsx"); }
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
</script>
</body>
</html>
