<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAJAGURU CMS v32 - Perfect Version</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: auto; display: none; }
        #loginPage { max-width: 400px; margin: 80px auto; background: white; padding: 40px; border-radius: 25px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-top: 10px solid #d32f2f; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; outline: none; }
        .header { background: #d32f2f; color: white; padding: 15px; text-align: center; border-radius: 12px; margin-bottom: 10px; position: relative; }
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .s-card { background: white; padding: 10px; border-radius: 10px; text-align: center; border-top: 4px solid #d32f2f; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .s-card p { margin: 5px 0 0; font-weight: bold; font-size: 15px; color: #1a237e; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border-left: 6px solid #d32f2f; }
        .tab-btn-group { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; background: #ddd; font-weight: bold; cursor: pointer; }
        .tab-active { background: #d32f2f; color: white; }
        label { display: block; font-weight: bold; margin-top: 10px; font-size: 13px; color: #555; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; margin-top: 12px; }
        .btn-save { background: #2e7d32; }
        .btn-wa { background: #25D366; }
        .btn-excel { background: #00703c; margin-top:0; margin-bottom:10px; }
        #adminView { display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; }
        th { background: #1a237e; color: white; }
        .act-btn { cursor: pointer; font-size: 16px; margin: 0 5px; }
        .logout-btn { position: absolute; right: 10px; top: 15px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="loginPage">
    <h2 style="color:#d32f2f;">RGF SOLUTIONS</h2>
    <input type="text" id="username" class="login-input" placeholder="User ID">
    <input type="password" id="password" class="login-input" placeholder="Password">
    <button class="btn btn-save" onclick="handleLogin()">LOGIN</button>
</div>

<div class="container" id="mainApp">
    <div class="header">
        <button class="logout-btn" onclick="location.reload()">Logout</button>
        <h2 style="margin:0;">RAJAGURU TRACKER</h2>
    </div>
    
    <div class="summary-grid">
        <div class="s-card"><h4>BOM BANK</h4><p id="sumB1">‚Çπ0</p></div>
        <div class="s-card"><h4>AIRTEL BAL</h4><p id="sumB2">‚Çπ0</p></div>
        <div class="s-card"><h4>PANDI ID</h4><p id="sumB3">‚Çπ0</p></div>
        <div class="s-card" style="background:#fff9c4;"><h4>CASH IN HAND</h4><p id="sumCIH" style="color:#d32f2f;">‚Çπ0</p></div>
    </div>

    <div class="tab-btn-group" id="tabBar">
        <button class="tab-btn tab-active" onclick="showTab('entrySection', this)">ENTRY</button>
        <button class="tab-btn" onclick="showTab('expenseSection', this)">EXPENSE</button>
        <button class="tab-btn" onclick="showTab('accountSection', this)">ACC IN/OUT</button>
    </div>

    <div id="entrySection" class="tab-content">
        <div class="card">
            <h3 id="formTitle" style="margin:0; color:#2e7d32;">New Transaction</h3>
            <input type="hidden" id="editId">
            <input type="date" id="date">
            <label>BOM ‚ûî Airtel Load</label><input type="number" id="h2a">
            <label>Airtel ‚ûî Rajapandi Load</label><input type="number" id="a2p">
            <label>Pandi Return Amount</label>
            <div style="display:flex; gap:10px;"><input type="number" id="p2h"><select id="mode"><option value="Cash">Cash</option><option value="Gpay">Gpay</option></select></div>
            <label>Bank Deposit (CIH ‚ûî Bank)</label><input type="number" id="bomDeposit">
            <button class="btn btn-save" id="saveBtnTrans" onclick="saveData('transactions')">üíæ SAVE ENTRY</button>
            <button class="btn btn-wa" onclick="shareToGroup()">üü¢ WHATSAPP SHARE</button>
            <button class="btn btn-admin" style="background:#1a237e;" onclick="goToAdmin()">üìä VIEW HISTORY</button>
        </div>
    </div>

    <div id="expenseSection" class="tab-content" style="display:none;">
        <div class="card" style="border-left-color:#f44336; background:#fff5f5;">
            <h3 id="expTitle" style="margin:0; color:#f44336;">Add Expense</h3>
            <input type="hidden" id="editExpId">
            <label>Detail</label><input type="text" id="expDetail" placeholder="Tea, Petrol etc.">
            <label>Amount</label><input type="number" id="expAmount">
            <label>Paid From</label><select id="expMode"><option value="Cash">Cash in Hand</option><option value="Gpay">Bank Account</option></select>
            <button class="btn btn-save" style="background:#f44336;" id="saveBtnExp" onclick="saveData('expenses')">üí∏ SAVE EXPENSE</button>
        </div>
    </div>

    <div id="accountSection" class="tab-content" style="display:none;">
        <div class="card" style="border-left-color:#2196f3; background:#f0f7ff;">
            <h3 id="accTitle" style="margin:0; color:#2196f3;">Account Log</h3>
            <input type="hidden" id="editAccId">
            <label>Detail</label><input type="text" id="accDetail">
            <label>Amount</label><input type="number" id="accAmount">
            <label>Type</label><select id="accType"><option value="IN">Cash IN</option><option value="OUT">Cash OUT</option></select>
            <button class="btn btn-save" style="background:#2196f3;" id="saveBtnAcc" onclick="saveData('account_log')">üè¶ SAVE LOG</button>
        </div>
    </div>

    <div id="adminView">
        <button class="btn btn-excel" onclick="downloadExcel()">üìä DOWNLOAD EXCEL</button>
        <div class="card">
            <h3>History</h3>
            <div style="overflow-x:auto;"><table id="historyTable"><thead><tr><th>Date</th><th>Type</th><th>Detail</th><th>Amount</th><th>Act</th></tr></thead><tbody id="reportTbody"></tbody></table></div>
            <button class="btn" style="background:#757575;" onclick="closeAdmin()">‚¨Ö Back</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCTfzmnIMbryZuGCm4iq_3C1vrjQk4BWF4",
        authDomain: "rgf-solutions.firebaseapp.com",
        databaseURL: "https://rgf-solutions-default-rtdb.firebaseio.com",
        projectId: "rgf-solutions",
        storageBucket: "rgf-solutions.firebasestorage.app",
        messagingSenderId: "324475817892",
        appId: "1:324475817892:web:103ecc2311e6b459f4fb31"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function handleLogin() {
        if(document.getElementById('username').value.trim()==="Manager" && document.getElementById('password').value.trim()==="Murugan") {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadFullReport();
        } else { alert("Wrong Login!"); }
    }

    function showTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        document.getElementById(tabId).style.display = 'block';
        btn.classList.add('tab-active');
    }

    let allData = {};

    function saveData(path) {
        let id;
        let data = { date: document.getElementById('date').value };
        
        if(path === 'transactions') {
            id = document.getElementById('editId').value || Date.now().toString();
            data.h2a = Number(document.getElementById('h2a').value) || 0;
            data.a2p = Number(document.getElementById('a2p').value) || 0;
            data.p2h = Number(document.getElementById('p2h').value) || 0;
            data.dep = Number(document.getElementById('bomDeposit').value) || 0;
            data.mode = document.getElementById('mode').value;
            data.type = "Entry";
        } else if(path === 'expenses') {
            id = document.getElementById('editExpId').value || Date.now().toString();
            data.detail = document.getElementById('expDetail').value;
            data.amount = Number(document.getElementById('expAmount').value) || 0;
            data.mode = document.getElementById('expMode').value;
            data.type = "Expense";
        } else if(path === 'account_log') {
            id = document.getElementById('editAccId').value || Date.now().toString();
            data.detail = document.getElementById('accDetail').value;
            data.amount = Number(document.getElementById('accAmount').value) || 0;
            data.mode = document.getElementById('accType').value;
            data.type = "AccountLog";
        }
        
        db.ref('rajaguru_v32/' + id).set(data).then(() => { 
            alert("Saved!"); 
            resetForms();
        });
    }

    function resetForms() {
        ["h2a","a2p","p2h","bomDeposit","editId","expDetail","expAmount","editExpId","accDetail","accAmount","editAccId"].forEach(f => document.getElementById(f).value = "");
        document.getElementById('formTitle').innerText = "New Transaction";
        document.getElementById('expTitle').innerText = "Add Expense";
        document.getElementById('accTitle').innerText = "Account Log";
        document.getElementById('saveBtnTrans').innerText = "üíæ SAVE ENTRY";
    }

    function loadFullReport() {
        db.ref('rajaguru_v32').on('value', snap => {
            const tbody = document.getElementById('reportTbody'); tbody.innerHTML = "";
            let bom=0, airtel=0, pandi=0, cih=0;
            allData = snap.val() || {};
            Object.keys(allData).sort().forEach(k => {
                const v = allData[k];
                let row = `<td>${v.date}</td><td>${v.type}</td>`;
                if(v.type === "Entry") {
                    bom += (v.dep - v.h2a); airtel += (v.h2a - v.a2p); pandi += (v.a2p - v.p2h);
                    if(v.mode === "Cash") cih += v.p2h; cih -= v.dep;
                    row += `<td>Load A2P</td><td>${v.a2p}</td>`;
                } else if(v.type === "Expense") {
                    if(v.mode === "Cash") cih -= v.amount; else bom -= v.amount;
                    row += `<td>${v.detail}</td><td style="color:red">-${v.amount}</td>`;
                } else if(v.type === "AccountLog") {
                    if(v.mode === "IN") bom += v.amount; else bom -= v.amount;
                    row += `<td>${v.detail}</td><td>${v.amount}</td>`;
                }
                tbody.innerHTML = `<tr>${row}<td>
                    <span class="act-btn" onclick="editRow('${k}')">‚úèÔ∏è</span>
                    <span class="act-btn" onclick="if(confirm('Delete?')) firebase.database().ref('rajaguru_v32/${k}').remove()">‚ùå</span>
                </td></tr>` + tbody.innerHTML;
            });
            document.getElementById('sumB1').innerText = "‚Çπ"+bom.toLocaleString();
            document.getElementById('sumB2').innerText = "‚Çπ"+airtel.toLocaleString();
            document.getElementById('sumB3').innerText = "‚Çπ"+pandi.toLocaleString();
            document.getElementById('sumCIH').innerText = "‚Çπ"+cih.toLocaleString();
        });
    }

    function editRow(k) {
        const v = allData[k];
        if(v.type === "Entry") {
            showTab('entrySection', document.querySelectorAll('.tab-btn')[0]);
            document.getElementById('editId').value = k;
            document.getElementById('date').value = v.date;
            document.getElementById('h2a').value = v.h2a;
            document.getElementById('a2p').value = v.a2p;
            document.getElementById('p2h').value = v.p2h;
            document.getElementById('bomDeposit').value = v.dep;
            document.getElementById('mode').value = v.mode;
            document.getElementById('formTitle').innerText = "Edit Transaction";
            document.getElementById('saveBtnTrans').innerText = "üîÑ UPDATE ENTRY";
        } else if(v.type === "Expense") {
            showTab('expenseSection', document.querySelectorAll('.tab-btn')[1]);
            document.getElementById('editExpId').value = k;
            document.getElementById('expDetail').value = v.detail;
            document.getElementById('expAmount').value = v.amount;
            document.getElementById('expMode').value = v.mode;
        } else if(v.type === "AccountLog") {
            showTab('accountSection', document.querySelectorAll('.tab-btn')[2]);
            document.getElementById('editAccId').value = k;
            document.getElementById('accDetail').value = v.detail;
            document.getElementById('accAmount').value = v.amount;
            document.getElementById('accType').value = v.mode;
        }
        closeAdmin();
    }

    function downloadExcel() {
        const table = document.getElementById("historyTable");
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, "Rajaguru_v32_Report.xlsx");
    }

    function goToAdmin() { 
        document.getElementById('tabBar').style.display='none';
        document.getElementById('entrySection').style.display='none';
        document.getElementById('expenseSection').style.display='none';
        document.getElementById('accountSection').style.display='none';
        document.getElementById('adminView').style.display='block'; 
    }
    function closeAdmin() { 
        document.getElementById('adminView').style.display='none'; 
        document.getElementById('tabBar').style.display='flex';
        document.getElementById('entrySection').style.display='block'; 
    }
    function shareToGroup() {
        const msg = `*üìä RAJAGURU REPORT*\nüìÖ *Date:* ${document.getElementById('date').value}\nüì± *Load:* ‚Çπ${document.getElementById('a2p').value}\nüíµ *Ret:* ‚Çπ${document.getElementById('p2h').value}\nüí∞ *CIH:* ${document.getElementById('sumCIH').innerText}`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
    }
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
</script>
</body>
</html>
